{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-trash-alt me-2"></i>Bulk Record Deletion</h4>
                </div>
                <div class="card-body">
                    <!-- Information Alert -->
                    <div class="alert alert-info">
                        <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Important Information</h5>
                        <p class="mb-2">This page allows you to delete records in bulk by month or year.</p>
                        <p class="mb-0">
                            <strong>To delete individual records:</strong> Please go to the 
                            <a hx-get="{% url 'reports:monthly' %}" hx-target="#dynamic-content" class="btn btn-outline-info">Monthly Report</a>
                            <!-- <a hx-get="{% url 'reports:yearly' %}" hx-target="#dynamic-content" class="btn btn-outline-info">Yearly Report</a>  -->
                            page and use the delete option next to each record.
                        </p>
                    </div>

                    <!-- Warning Alert -->
                    <div class="alert alert-warning">
                        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Warning</h5>
                        <p class="mb-0">Bulk deletion is permanent and cannot be undone. Please be certain before proceeding.</p>
                    </div>

                    {% if months_with_records %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Month/Year</th>
                                    <th>Number of Records</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in months_with_records %}
                                <tr>
                                    <td>
                                        <strong>{{ record.month_name }} {{ record.year }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary rounded-pill">{{ record.record_count }}</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteMonthModal{{ record.month }}_{{ record.year }}">
                                            <i class="fas fa-trash me-1"></i> Delete Month
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- Delete Month Modal -->
                                <div class="modal fade" id="deleteMonthModal{{ record.month }}_{{ record.year }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title">Confirm Deletion</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p>Are you sure you want to delete all <strong>{{ record.record_count }}</strong> records for <strong>{{ record.month_name }} {{ record.year }}</strong>?</p>
                                                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <form method="POST" action="{% url 'reports:delete_month_records' record.month record.year %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="confirm_delete" value="true">
                                                    <button type="submit" class="btn btn-danger">Delete All Records</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Yearly Summary Section -->
                    <div class="mt-5">
                        <h5 class="border-bottom pb-2">Delete by Year</h5>
                        <div class="row">
                            {% for year_record in years_with_counts %}
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Year {{ year_record.year }}</h6>
                                        <p class="card-text">
                                            <span class="badge bg-info">{{ year_record.record_count }} records</span>
                                        </p>
                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteYearModal{{ year_record.year }}">
                                            <i class="fas fa-trash me-1"></i> Delete Year
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Delete Year Modal -->
                            <div class="modal fade" id="deleteYearModal{{ year_record.year }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">Confirm Year Deletion</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete all <strong>{{ year_record.record_count }}</strong> records for the year <strong>{{ year_record.year }}</strong>?</p>
                                            <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <form method="POST" action="{% url 'reports:delete_year_records' year_record.year %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="confirm_delete" value="true">
                                                <button type="submit" class="btn btn-danger">Delete All Year Records</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <h5>No records found</h5>
                        <p class="text-muted">There are no records available for deletion.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
// Function to show a Bootstrap toast notification
function showToast(message, type = 'info') {
    // Remove any existing toast containers
    $('.toast-container').remove();
    
    // Create toast container
    const toastContainer = $('<div>').addClass('toast-container position-fixed top-0 end-0 p-3');
    
    // Create toast element
    const toast = $('<div>').addClass('toast align-items-center text-white bg-' + type)
        .addClass(type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info')
        .attr('role', 'alert').attr('aria-live', 'assertive').attr('aria-atomic', 'true');
    
    // Create toast content
    const toastContent = $('<div>').addClass('d-flex');
    const toastBody = $('<div>').addClass('toast-body').text(message);
    const closeButton = $('<button>').addClass('btn-close btn-close-white me-2 m-auto')
        .attr('type', 'button').attr('data-bs-dismiss', 'toast').attr('aria-label', 'Close');
    
    // Assemble toast
    toastContent.append(toastBody).append(closeButton);
    toast.append(toastContent);
    toastContainer.append(toast);
    
    // Add to body and show
    $('body').append(toastContainer);
    
    // Initialize and show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.on('hidden.bs.toast', function () {
        toastContainer.remove();
    });
}

// Function to handle form submissions with AJAX
function handleDeleteForm(form, url) {
    form.on('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitButton = form.find('button[type="submit"]');
        const originalText = submitButton.html();
        submitButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
        
        // Send AJAX request
        $.ajax({
            url: url,
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    showToast(response.message, 'success');
                    // Close the modal
                    form.closest('.modal').modal('hide');
                    // Reload the page after a short delay to reflect changes
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                } else {
                    showToast(response.message, 'error');
                    submitButton.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    showToast(response.message, 'error');
                } catch (e) {
                    showToast('An error occurred while processing your request.', 'error');
                }
                submitButton.prop('disabled', false).html(originalText);
            }
        });
    });
}

// Initialize when document is ready
$(document).ready(function() {
    // Attach event handlers to all delete forms
    $('form[action*="delete-month"]').each(function() {
        handleDeleteForm($(this), $(this).attr('action'));
    });
    
    $('form[action*="delete-year"]').each(function() {
        handleDeleteForm($(this), $(this).attr('action'));
    });
});
</script>
{% endblock %}